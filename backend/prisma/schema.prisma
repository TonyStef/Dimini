// Dimini Database Schema
// AI-Powered Therapy Visualization Platform

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider  = "prisma-client-py"
  interface = "asyncio"
}

// ============================================
// USER & THERAPIST MANAGEMENT
// ============================================

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String   @map("password_hash")
  name          String
  role          UserRole @default(THERAPIST)
  
  // Relations
  patients      Patient[]
  sessions      Session[] @relation("TherapistSessions")
  auditLogs     AuditLog[]
  
  // Security fields
  tokenVersion         Int       @default(0) @map("token_version")
  resetToken           String?   @unique @map("reset_token")
  resetTokenExpiry     DateTime? @map("reset_token_expiry")
  lastPasswordChange   DateTime? @map("last_password_change")
  failedLoginAttempts  Int       @default(0) @map("failed_login_attempts")
  accountLockedUntil   DateTime? @map("account_locked_until")
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  @@index([email])
  @@index([resetToken])
  @@index([resetTokenExpiry])
  @@map("users")
}

enum UserRole {
  ADMIN
  THERAPIST
  ASSISTANT
}

// ============================================
// PATIENT MANAGEMENT
// ============================================

model Patient {
  id            String   @id @default(cuid())
  therapistId   String   @map("therapist_id")
  therapist     User     @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  
  name          String
  email         String?
  phone         String?
  demographics  Json?    @db.Json // age, gender, occupation, etc.

  // Relations
  sessions      Session[]
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  @@index([therapistId])
  @@map("patients")
}

// ============================================
// THERAPY SESSION MANAGEMENT
// ============================================

model Session {
  id            String   @id @default(cuid())
  patientId     String   @map("patient_id")
  patient       Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  therapistId   String   @map("therapist_id")
  therapist     User     @relation("TherapistSessions", fields: [therapistId], references: [id])

  startedAt     DateTime @default(now()) @map("started_at")
  endedAt       DateTime? @map("ended_at")
  transcript    String   @default("") @db.Text
  summary       Json?    // AI-generated summary
  status        SessionStatus @default(ACTIVE)

  // Hume AI integration
  humeChatId    String?  @unique @map("hume_chat_id")

  // Real-time aggregation (JSONB for fast UI reads)
  emotionTimeline  Json?  @map("emotion_timeline") @db.Json   // [{timestamp, emotion, intensity}]
  primaryEmotions  Json?  @map("primary_emotions") @db.Json   // {emotion: {avg_intensity, occurrences}}
  topicsDiscussed  Json?  @map("topics_discussed") @db.Json   // ["work", "family", ...]
  breakthroughs    Json?  @map("breakthroughs") @db.Json      // [{time, description}]
  concernsSummary  Json?  @map("concerns_summary") @db.Json   // {high: 2, moderate: 1, urgent: 0}

  // Relations - Voice Agent Tools (Phase 4)
  notes         SessionNote[]
  progress      SessionProgress[]
  concerns      SessionConcern[]
  storedSummary StoredSessionSummary?

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@index([patientId])
  @@index([therapistId])
  @@index([status])
  @@index([startedAt])
  @@index([humeChatId])
  @@map("sessions")
}

enum SessionStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

// ============================================
// AUDIT & SECURITY
// ============================================
// NOTE: Graph data (nodes, edges) now stored in Neo4j, not PostgreSQL

model AuditLog {
  id              String   @id @default(cuid())

  userId          String   @map("user_id")
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  section         String   // 'profile', 'patient', 'session'
  action          String   // 'created', 'updated', 'deleted', 'viewed'

  changesBefore   Json?    @map("changes_before")
  changesAfter    Json?    @map("changes_after")

  ipAddress       String   @map("ip_address")
  userAgent       String   @map("user_agent")

  createdAt       DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([section])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// VOICE AGENT TOOL DATA STORAGE (Phase 4)
// ============================================

model SessionNote {
  id          String          @id @default(cuid())
  sessionId   String          @map("session_id")
  session     Session         @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  content     String          @db.Text
  category    NoteCategory
  importance  ImportanceLevel
  source      String          @default("ai_agent")

  timestamp   DateTime        @default(now())
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  @@index([sessionId])
  @@index([category])
  @@index([sessionId, importance])
  @@map("session_notes")
}

enum NoteCategory {
  INSIGHT
  OBSERVATION
  CONCERN
  PROGRESS
}

enum ImportanceLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model SessionProgress {
  id            String       @id @default(cuid())
  sessionId     String       @map("session_id")
  session       Session      @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  progressType  ProgressType @map("progress_type")
  description   String       @db.Text
  evidence      String?      @db.Text

  flaggedAt     DateTime     @default(now()) @map("flagged_at")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  @@index([sessionId])
  @@index([progressType])
  @@map("session_progress")
}

enum ProgressType {
  EMOTIONAL_REGULATION
  INSIGHT_GAINED
  BEHAVIORAL_CHANGE
  COPING_SKILL
}

model SessionConcern {
  id                  String        @id @default(cuid())
  sessionId           String        @map("session_id")
  session             Session       @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  concernType         ConcernType   @map("concern_type")
  severity            SeverityLevel
  description         String        @db.Text
  recommendedAction   String?       @map("recommended_action") @db.Text

  flaggedAt           DateTime      @default(now()) @map("flagged_at")
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")

  @@index([sessionId])
  @@index([severity])
  @@index([sessionId, severity])
  @@map("session_concerns")
}

enum ConcernType {
  EMOTIONAL_DISTRESS
  RISK_BEHAVIOR
  DETERIORATION
  CRISIS_INDICATOR
}

enum SeverityLevel {
  MODERATE
  HIGH
  URGENT
}

model StoredSessionSummary {
  id                  String   @id @default(cuid())
  sessionId           String   @unique @map("session_id")
  session             Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  emotionsData        Json?    @map("emotions_data") @db.Json
  topicsData          Json?    @map("topics_data") @db.Json
  recommendationsData Json?    @map("recommendations_data") @db.Json

  generatedAt         DateTime @default(now()) @map("generated_at")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  @@map("session_summaries")
}