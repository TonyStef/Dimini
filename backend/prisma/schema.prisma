// Dimini Database Schema
// AI-Powered Therapy Visualization Platform

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================
// USER & THERAPIST MANAGEMENT
// ============================================

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String   @map("password_hash")
  name          String
  role          UserRole @default(THERAPIST)
  
  // Relations
  patients      Patient[]
  sessions      Session[] @relation("TherapistSessions")
  auditLogs     AuditLog[]
  
  // Security fields
  tokenVersion         Int       @default(0) @map("token_version")
  resetToken           String?   @unique @map("reset_token")
  resetTokenExpiry     DateTime? @map("reset_token_expiry")
  lastPasswordChange   DateTime? @map("last_password_change")
  failedLoginAttempts  Int       @default(0) @map("failed_login_attempts")
  accountLockedUntil   DateTime? @map("account_locked_until")
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  @@index([email])
  @@index([resetToken])
  @@index([resetTokenExpiry])
  @@map("users")
}

enum UserRole {
  ADMIN
  THERAPIST
  ASSISTANT
}

// ============================================
// PATIENT MANAGEMENT
// ============================================

model Patient {
  id            String   @id @default(cuid())
  therapistId   String   @map("therapist_id")
  therapist     User     @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  
  name          String
  email         String?
  phone         String?
  demographics  Json?    @db.Json // age, gender, occupation, etc.
  
  // Relations
  sessions      Session[]
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  @@index([therapistId])
  @@map("patients")
}

// ============================================
// THERAPY SESSION MANAGEMENT
// ============================================

model Session {
  id            String   @id @default(cuid())
  patientId     String   @map("patient_id")
  patient       Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  therapistId   String   @map("therapist_id")
  therapist     User     @relation("TherapistSessions", fields: [therapistId], references: [id])
  
  startedAt     DateTime @default(now()) @map("started_at")
  endedAt       DateTime? @map("ended_at")
  transcript    String   @default("") @db.Text
  summary       Json?    // AI-generated summary
  status        SessionStatus @default(ACTIVE)
  
  // Relations
  graphNodes    GraphNode[]
  graphEdges    GraphEdge[]
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  @@index([patientId])
  @@index([therapistId])
  @@index([status])
  @@index([startedAt])
  @@map("sessions")
}

enum SessionStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

// ============================================
// GRAPH VISUALIZATION DATA
// ============================================

model GraphNode {
  id               String   @id @default(cuid())
  sessionId        String   @map("session_id")
  session          Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  nodeId           String   @map("node_id") // Unique within session: "anxiety", "work_stress"
  nodeType         NodeType @map("node_type")
  label            String   // Display label: "Anxiety", "Work Stress"
  embedding        Json     // Store OpenAI embedding as JSON array
  properties       Json?    @default("{}") @db.Json
  
  firstMentionedAt DateTime @default(now()) @map("first_mentioned_at")
  mentionCount     Int      @default(1) @map("mention_count")
  
  createdAt        DateTime @default(now()) @map("created_at")
  
  @@unique([sessionId, nodeId])
  @@index([sessionId])
  @@index([nodeType])
  @@map("graph_nodes")
}

enum NodeType {
  TOPIC
  EMOTION
}

model GraphEdge {
  id               String   @id @default(cuid())
  sessionId        String   @map("session_id")
  session          Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  sourceNodeId     String   @map("source_node_id")
  targetNodeId     String   @map("target_node_id")
  similarityScore  Float    @map("similarity_score") // 0.75 to 1.0
  relationshipType String   @default("related_to") @map("relationship_type")
  properties       Json?    @default("{}") @db.Json
  
  createdAt        DateTime @default(now()) @map("created_at")
  
  @@unique([sessionId, sourceNodeId, targetNodeId])
  @@index([sessionId])
  @@index([similarityScore])
  @@map("graph_edges")
}

// ============================================
// AUDIT & SECURITY
// ============================================

model AuditLog {
  id              String   @id @default(cuid())
  
  userId          String   @map("user_id")
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  section         String   // 'profile', 'patient', 'session'
  action          String   // 'created', 'updated', 'deleted', 'viewed'
  
  changesBefore   Json?    @map("changes_before")
  changesAfter    Json?    @map("changes_after")
  
  ipAddress       String   @map("ip_address")
  userAgent       String   @map("user_agent")
  
  createdAt       DateTime @default(now()) @map("created_at")
  
  @@index([userId])
  @@index([section])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}